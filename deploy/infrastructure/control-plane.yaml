# Cluster API â€“ KubeadmControlPlane for Hetzner
#
# Provisions an HA control plane using kubeadm on Hetzner Cloud.
# NOTE: The 'replicas' value below is a default. At apply time, bootstrap.yml
# and bootstrap.sh template this value from CONTROL_PLANE_MACHINE_COUNT
# (default: 1) to stay within Hetzner server limits.
---
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlane
metadata:
  name: dkpbot-prod-control-plane
  namespace: default
spec:
  replicas: 3
  version: v1.31.4
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: HCloudMachineTemplate
      name: dkpbot-prod-control-plane
  kubeadmConfigSpec:
    initConfiguration:
      nodeRegistration:
        kubeletExtraArgs:
          cloud-provider: external
    joinConfiguration:
      nodeRegistration:
        kubeletExtraArgs:
          cloud-provider: external
    clusterConfiguration:
      apiServer:
        extraArgs:
          cloud-provider: external
      controllerManager:
        extraArgs:
          cloud-provider: external
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: HCloudMachineTemplate
metadata:
  name: dkpbot-prod-control-plane
  namespace: default
spec:
  template:
    spec:
      type: cpx21
      imageName: ubuntu-22.04
