name: Bootstrap Infrastructure

# Manual trigger only — not part of CI.
# Use the "Run workflow" button in the Actions tab to launch.
#
# Prerequisites:
#   Run the "Build Hetzner Node Image" workflow first to create the
#   pre-baked Hetzner snapshot that capictl requires.
on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "Kubernetes cluster name"
        required: false
        default: "dkpbot-prod"
      hcloud_region:
        description: "Hetzner Cloud region (nbg1, fsn1, hel1)"
        required: false
        default: "nbg1"
      control_plane_count:
        description: "Number of control-plane nodes"
        required: false
        default: "1"
      worker_count:
        description: "Number of worker nodes"
        required: false
        default: "1"
      machine_type:
        description: "Hetzner machine type (cx23, cx33, cx43)"
        required: false
        default: "cx23"
      kubernetes_version:
        description: "Kubernetes version (must match the pre-built snapshot)"
        required: false
        default: "1.31.6"
      flux_branch:
        description: "Git branch for FluxCD to track (defaults to dispatched branch)"
        required: false
        default: ""
      discord_token:
        description: "Discord bot token (leave empty to use DISCORD_TOKEN secret)"
        required: false
        default: ""
      discord_guild_id:
        description: "Discord guild ID (leave empty to use DISCORD_GUILD_ID secret)"
        required: false
        default: ""
      cnpg_s3_endpoint:
        description: "Hetzner S3 endpoint URL (e.g. https://nbg1.your-objectstorage.com)"
        required: false
        default: ""
      cnpg_s3_bucket:
        description: "S3 bucket name for CNPG backups"
        required: false
        default: "dkpbot-backups"

# Required GitHub repository secrets (Settings → Secrets and variables → Actions):
#
#   HCLOUD_TOKEN         — Hetzner Cloud API token (Read + Write)
#   CNPG_S3_ACCESS_KEY   — Hetzner Object Storage access key ID
#   CNPG_S3_SECRET_KEY   — Hetzner Object Storage secret access key
#
# Optional secrets:
#   DISCORD_TOKEN        — Discord bot token
#   DISCORD_GUILD_ID     — Discord guild ID

permissions:
  contents: write    # Flux bootstrap commits to the repo

jobs:
  bootstrap:
    name: Bootstrap Hetzner Cluster via capictl
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CLUSTER_NAME:                     ${{ inputs.cluster_name }}
      HCLOUD_TOKEN:                     ${{ secrets.HCLOUD_TOKEN }}
      HCLOUD_REGION:                    ${{ inputs.hcloud_region }}
      HCLOUD_CONTROL_PLANE_MACHINE_TYPE: ${{ inputs.machine_type }}
      HCLOUD_WORKER_MACHINE_TYPE:        ${{ inputs.machine_type }}
      CONTROL_PLANE_NODE_COUNT:         ${{ inputs.control_plane_count }}
      WORKER_NODE_COUNT:                ${{ inputs.worker_count }}
      KUBERNETES_VERSION:               ${{ inputs.kubernetes_version }}
      GITHUB_TOKEN:                     ${{ secrets.GITHUB_TOKEN }}
      GITHUB_USER:                      ${{ github.repository_owner }}

    steps:
      # ── Validate ────────────────────────────────────────────────
      - name: Validate secrets and pre-baked image
        run: |
          if [[ -z "${HCLOUD_TOKEN}" ]]; then
            echo "::error::HCLOUD_TOKEN secret is not set."
            exit 1
          fi

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${HCLOUD_TOKEN}" \
            "https://api.hetzner.cloud/v1/locations?per_page=1") || HTTP_CODE="000"
          if [[ "${HTTP_CODE}" == "401" || "${HTTP_CODE}" == "403" ]]; then
            echo "::error::HCLOUD_TOKEN is invalid (HTTP ${HTTP_CODE})."
            exit 1
          fi
          echo "✅ HCLOUD_TOKEN is valid."

          # Require a pre-baked snapshot — capictl will not work without one
          IMAGE_COUNT=$(curl -sf \
            -H "Authorization: Bearer ${HCLOUD_TOKEN}" \
            "https://api.hetzner.cloud/v1/images?type=snapshot&label_selector=caph-image-name" \
            | jq '.images | length')
          if [[ "${IMAGE_COUNT}" -eq 0 ]]; then
            echo "::error::No Hetzner snapshot with label 'caph-image-name' found."
            echo "::error::Run the 'Build Hetzner Node Image' workflow first, then retry."
            exit 1
          fi
          echo "✅ Found ${IMAGE_COUNT} pre-baked snapshot(s)."

          if [[ -z "${{ secrets.CNPG_S3_ACCESS_KEY }}" ]]; then
            echo "::warning::CNPG_S3_ACCESS_KEY not set — CNPG backups will need manual configuration."
          fi

      - uses: actions/checkout@v4

      # ── Install tooling ─────────────────────────────────────────
      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind

      - name: Install clusterctl
        run: |
          curl -Lo ./clusterctl https://github.com/kubernetes-sigs/cluster-api/releases/download/v1.9.4/clusterctl-linux-amd64
          chmod +x ./clusterctl && sudo mv ./clusterctl /usr/local/bin/clusterctl

      - name: Install hcloud CLI
        run: |
          curl -Lo ./hcloud.tar.gz https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz
          tar -xzf hcloud.tar.gz hcloud && chmod +x hcloud && sudo mv hcloud /usr/local/bin/hcloud
          rm -f hcloud.tar.gz

      - name: Install Flux CLI
        run: curl -s https://fluxcd.io/install.sh | sudo bash

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.16.4"

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install yq
        run: |
          curl -Lo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Install cilium CLI
        run: |
          CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
          curl -Lo ./cilium.tar.gz \
            "https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-amd64.tar.gz"
          tar -xzf cilium.tar.gz cilium && chmod +x cilium && sudo mv cilium /usr/local/bin/cilium
          rm -f cilium.tar.gz

      # ── Clone capictl ───────────────────────────────────────────
      - name: Clone capictl
        run: git clone --depth=1 https://github.com/nicholasdille/capictl.git /tmp/capictl

      # ── Run capictl ─────────────────────────────────────────────
      # capictl handles: Kind bootstrap cluster, clusterctl init, cluster
      # provisioning with pre-baked image, Cilium CNI, CCM/CSI via
      # ClusterResourceSets, CAPI pivot, and Kind cluster cleanup.
      - name: Run capictl
        working-directory: /tmp/capictl
        run: |
          bash capictl \
            -n "${CLUSTER_NAME}" \
            -i hetzner \
            -b kind \
            -v "v${KUBERNETES_VERSION}" \
            -c "${CONTROL_PLANE_NODE_COUNT}" \
            -w "${WORKER_NODE_COUNT}"
        env:
          HCLOUD_TOKEN:                     ${{ secrets.HCLOUD_TOKEN }}
          HCLOUD_REGION:                    ${{ inputs.hcloud_region }}
          HCLOUD_CONTROL_PLANE_MACHINE_TYPE: ${{ inputs.machine_type }}
          HCLOUD_WORKER_MACHINE_TYPE:        ${{ inputs.machine_type }}

      - name: Export kubeconfig
        run: |
          cp /tmp/capictl/kubeconfig-${CLUSTER_NAME} /tmp/workload.kubeconfig
          echo "KUBECONFIG=/tmp/workload.kubeconfig" >> "$GITHUB_ENV"

      # ── FluxCD bootstrap ────────────────────────────────────────
      - name: Bootstrap FluxCD
        run: |
          FLUX_BRANCH="${{ inputs.flux_branch }}"
          FLUX_BRANCH="${FLUX_BRANCH:-${{ github.ref_name }}}"
          echo "FluxCD will track branch: ${FLUX_BRANCH}"

          flux bootstrap github \
            --owner="${GITHUB_USER}" \
            --repository="${{ github.event.repository.name }}" \
            --branch="${FLUX_BRANCH}" \
            --path=deploy/flux \
            --personal \
            --token-auth

      - name: Apply Flux Kustomizations
        run: |
          kubectl apply -f deploy/flux/kustomizations/helm-values-configmaps.yaml
          kubectl apply -f deploy/flux/kustomizations/

      # ── Secrets ─────────────────────────────────────────────────
      - name: Create CNPG S3 backup credentials
        run: |
          kubectl create namespace dkpbot --dry-run=client -o yaml | kubectl apply -f -

          S3_ACCESS="${{ secrets.CNPG_S3_ACCESS_KEY }}"
          S3_SECRET="${{ secrets.CNPG_S3_SECRET_KEY }}"
          if [[ -n "${S3_ACCESS}" && -n "${S3_SECRET}" ]]; then
            kubectl -n dkpbot create secret generic backup-s3-credentials \
              --from-literal=ACCESS_KEY_ID="${S3_ACCESS}" \
              --from-literal=ACCESS_SECRET_KEY="${S3_SECRET}" \
              --dry-run=client -o yaml | kubectl apply -f -
            echo "✅ backup-s3-credentials created."
          else
            echo "::warning::CNPG S3 credentials not set — create backup-s3-credentials manually."
          fi

      - name: Create DKP bot secrets
        run: |
          DISCORD_TOK="${{ inputs.discord_token }}"
          DISCORD_GID="${{ inputs.discord_guild_id }}"
          [[ -z "${DISCORD_TOK}" ]] && DISCORD_TOK="${{ secrets.DISCORD_TOKEN }}"
          [[ -z "${DISCORD_GID}" ]] && DISCORD_GID="${{ secrets.DISCORD_GUILD_ID }}"
          DISCORD_TOK="${DISCORD_TOK:-REPLACE_ME}"
          DISCORD_GID="${DISCORD_GID:-REPLACE_ME}"

          if [[ "${DISCORD_TOK}" == "REPLACE_ME" ]]; then
            echo "::warning::Discord credentials not set — update dkpbot-secrets manually after bootstrap."
          fi

          kubectl -n flux-system create secret generic dkpbot-secrets \
            --from-literal=config.discord.token="${DISCORD_TOK}" \
            --from-literal=config.discord.guild_id="${DISCORD_GID}" \
            --dry-run=client -o yaml | kubectl apply -f -

      # ── Upload kubeconfig ────────────────────────────────────────
      - name: Upload kubeconfig
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig-${{ inputs.cluster_name }}
          path: /tmp/workload.kubeconfig
          retention-days: 1

      # ── Summary ─────────────────────────────────────────────────
      - name: Summary
        if: success()
        run: |
          FLUX_BRANCH="${{ inputs.flux_branch }}"
          FLUX_BRANCH="${FLUX_BRANCH:-${{ github.ref_name }}}"

          echo "## ✅ Cluster \`${CLUSTER_NAME}\` bootstrapped!" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Region:** ${{ inputs.hcloud_region }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Kubernetes:** v${{ inputs.kubernetes_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Nodes:** ${{ inputs.control_plane_count }}× CP + ${{ inputs.worker_count }}× worker (${{ inputs.machine_type }})" >> "$GITHUB_STEP_SUMMARY"
          echo "**FluxCD branch:** \`${FLUX_BRANCH}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Next steps" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Download the kubeconfig artifact from this run (expires in 1 day)" >> "$GITHUB_STEP_SUMMARY"
          if [[ -z "${{ secrets.DISCORD_TOKEN }}" && -z "${{ inputs.discord_token }}" ]]; then
            echo "2. ⚠️ Set Discord credentials: \`kubectl -n flux-system edit secret dkpbot-secrets\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [[ -z "${{ secrets.CNPG_S3_ACCESS_KEY }}" ]]; then
            echo "3. ⚠️ Create CNPG backup credentials in the \`dkpbot\` namespace" >> "$GITHUB_STEP_SUMMARY"
          fi
