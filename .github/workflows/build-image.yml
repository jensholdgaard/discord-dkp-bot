name: Build Hetzner Node Image

# Run this workflow once before bootstrapping a cluster, or whenever you
# need to update the Kubernetes version baked into the Hetzner snapshot.
# The resulting snapshot is used by bootstrap.yml via capictl.
on:
  workflow_dispatch:
    inputs:
      kubernetes_version:
        description: "Kubernetes version to bake (without 'v' prefix)"
        required: false
        default: "1.31.6"
      containerd_version:
        description: "containerd version to bake"
        required: false
        default: "1.7.26"
      hcloud_region:
        description: "Hetzner region to build the image in"
        required: false
        default: "nbg1"

permissions:
  contents: read

jobs:
  build:
    name: Build Ubuntu 24.04 + Kubernetes ${{ inputs.kubernetes_version }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

    steps:
      - name: Validate secrets
        run: |
          if [[ -z "${HCLOUD_TOKEN}" ]]; then
            echo "::error::HCLOUD_TOKEN secret is not set."
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Install Packer
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
            | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -y && sudo apt-get install -y packer

      - name: Check if image already exists
        id: check_image
        run: |
          COUNT=$(curl -sf \
            -H "Authorization: Bearer ${HCLOUD_TOKEN}" \
            "https://api.hetzner.cloud/v1/images?type=snapshot&label_selector=kubernetes=${{ inputs.kubernetes_version }}" \
            | jq '.images | length')
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          if [[ "${COUNT}" -gt 0 ]]; then
            echo "::notice::Snapshot for k8s ${{ inputs.kubernetes_version }} already exists (${COUNT} image(s)). Set a different version or delete the existing snapshot to rebuild."
          fi

      - name: Initialize Packer plugins
        if: steps.check_image.outputs.count == '0'
        working-directory: deploy/infrastructure/packer
        run: packer init .

      - name: Build Hetzner snapshot
        if: steps.check_image.outputs.count == '0'
        working-directory: deploy/infrastructure/packer
        run: |
          packer build \
            -var "kubernetes_version=${{ inputs.kubernetes_version }}" \
            -var "containerd_version=${{ inputs.containerd_version }}" \
            -var "build_location=${{ inputs.hcloud_region }}" \
            ubuntu.pkr.hcl
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          PKR_VAR_HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Verify snapshot
        run: |
          IMAGES=$(curl -sf \
            -H "Authorization: Bearer ${HCLOUD_TOKEN}" \
            "https://api.hetzner.cloud/v1/images?type=snapshot&label_selector=kubernetes=${{ inputs.kubernetes_version }}" \
            | jq -r '.images[] | "\(.id)  \(.description)  created=\(.created)"')
          echo "Snapshots for k8s ${{ inputs.kubernetes_version }}:"
          echo "${IMAGES}"

      - name: Summary
        if: always()
        run: |
          echo "## Hetzner Snapshot Build" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Kubernetes:** ${{ inputs.kubernetes_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**containerd:** ${{ inputs.containerd_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Region:** ${{ inputs.hcloud_region }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ "${{ steps.check_image.outputs.count }}" -gt 0 ]]; then
            echo "ℹ️ Snapshot already existed — no new build performed." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ Snapshot created successfully. You can now run the Bootstrap workflow." >> "$GITHUB_STEP_SUMMARY"
          fi
